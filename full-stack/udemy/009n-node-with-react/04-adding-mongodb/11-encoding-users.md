# Encoding Users
[overview flow diagram](https://i.imgur.com/yr43GdM.png)

## Creating the cookie
![create cookie diagram](https://i.imgur.com/QNbSx12.png)

### What do we need to do now?
* We need to take the user Model instance record
* And generate some unique identifying piece of info
* Then pass it in a cookie that will then be provided in any follow up request to our server
    - It is kind of a complicated step

### Diagram to understand how we'll deal with this cookie step
![cookie step diagram](https://i.imgur.com/vfkFXOW.png)

1. Inside browser someone says "I want to log into this app!"
2. They go through the oAuth flow
3. Then they come back to our app server with the Google profile
4. Our server than says, "Looks like you have the same google profile ID as user123 so I need to give you a token that says you are user123"
5. **serializeUser()** (_I will define that function (technically I will define a functiona and pass it to serializeUser()_) will automatically be called by Passport with our User model that we just fetched in step 3 (above)
    * We are going to use that User model to generate our identifying piece of info
    * And after we do that we'll pass that identifying piece of info back to Passport and Passport will automatically stuff that `token` into the User's cookie for us
6. Cookie is sent back to user's browser in the response
7. Once the user wants to make some type of follow up request:
    * They ask for a list of posts
    * Or a list of surveys
    * Or something from us
    * Some request will be sent from our browser to our app server
    * When they make that request the cookie will automatically be added into the request by the browser
8. On the server Passport will take that identifying piece of info from the cookie and then it will pass it into a second function called **deserializeUser()** (I will define this function)
    * What does `deserializeUser()` do?
        - It takes that identifying piece of info and somehow turn it back into a User Model that uniquely id's this user
9. We pass that "de-derialized" piece of info back to Passport and then we say, "Yes, this is the same user123!, they are authenticated, let's give them the list they requested"
10. The response gets sent to the browser with the payload of data they requested

## Let's do it!
`passport.js`

```js
// more code
passport.serializeUser((user, done) => {});
// more code
```

* What does the about `user` represent?
    - User logs in and goes through Google Strategy flow
    - from that callback we either retrieve a user instance from our Database or we create a new instance
    - That `user` is exactly what is passed to `serializeUser(user, done)`
    - `done` - Remember we use `done` with Passport to let it know when we have "done some work and that will nudge it along to it's next step"
    - The first object `done(null, user.id);` is the error object, we don't expect any errors to occur so we just enter `null` for that value
    - CONFUSING PART - `user.id` is NOT the Google Profile ID
        + WTF?
        + To explain open mLab to your Documents

![document user.id](https://i.imgur.com/kedUbCN.png)

* `_id` is the unique identifier of the user record
* Every new record in Mongo gets an `_id` auto generated
* So `user.id` in this case is holding the `_id` of that record
    - It is a shortcut to the `59948fb6181796244c248d20` (In my screenshot)
        + You don't have to access it with `_id.$oid`
    - Yours and every record in Mongo each has a unique `_id`

## Why don't we just use the Google ID?
* Great question
* Because they might not always sign in with Google
    - They could also sign in with other OAuths we may implement down the road (Facebook, Twitter, Github, LinkedIn...)
    - So we can't assume that every user will have a Google ID but we can assume that every user will have an `_id` generated by Mongo

### More reasons why we are using the user _id and User Model profile id
![user _id](https://i.imgur.com/BJ0Sp2A.png)

* When user signs in with Google Oauth Flow and gets their Profile ID, we don't care about that profile id anymore, it doesn't matter
* After they sign in, we only care about our own internal ID, which is the `MongoDB` user `_id`

## Next - deSerialize()
* We will take that unique piece of information from our cookie and turn it back into a User Model
