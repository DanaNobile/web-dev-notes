# Fixing Heroku proxy issues
* We need to fix our Heroku mismatch error from Google
* We saw this before
    - It says we are telling that wherever we are trying to redirect the user to after they go into our OAuth flow is not whitelisted as a valid callback address
    - And if we look at our address on Google `Authorized redirect URIs` it looks to be correct
    - But take a closer look at the error and you'll see that it is telling us we are trying to redirect to `http` and not `https`
    - But we did use https when we created this on Google
    - Something at some point in time is breaking and sending it to http
    - Anything that is tied to authentication we ALWAYS want to use HTTPS wherever possible because we are dealing with sensative data

## The http is being generated by two different factors
### Problem #1
* In `passport.js` we specified a **callbackURL** that uses a `relative` path

`/auth/google/callback`

* We used a `relative` path to help make our life easier and not have specify the domains and it can deal with either http or https
* Doing this we don't have to worry about what domain we're using
    - We use either
        + localhost:5000/
        + or
        + mysterious-sierra-29112.herokuapp.com
* Relative paths save us from changing the domains all the time
* The problem is the Google Strategy because it is deciding what domain to put on the URL
    - In development it is appending the correct domain
    - In production it is appending the wrong domain

# Diagram about browser
![browser diagram](https://i.imgur.com/GsL7vff.png)

* Here is what happens when our browser makes a request to our server running on Heroku servers
* Heroku uses a proxy (or a load balancer ) to make sure the traffic from our browser is routed to the correct server
* By default the proxy assumes that all requests that go through the proxy should no longer be https because it inherently does not want to trust requests that come through a proxy
    - In our case we are ok with the security provided by Heroku
    - And we can trust in the Heroku proxy
    - We just need to add one configuration to our Google Strategy to tell it to trust any proxies that the browsers encounter between our servers and the original request

## The other solution
* Just spell out the entire path for development and production

`prod.js`

```js
// prod.js - production keys here!!!
module.exports = {
  googleClientID: process.env.GOOGLE_CLIENT_ID,
  googleClientSecret: process.env.GOOGLE_CLIENT_SECRET,
  mongoURI: process.env.MONGO_URI,
  randomCookieKey: process.env.RANDOM_COOKIE_KEY,
  googleRedirectURI: 'https://mysterious-sierra-29112.herokuapp.com/'
};
```

`dev.js`

```js
// dev.js - NEVER COMMIT THIS!!!
module.exports = {
  googleClientID:
    '1005918912077-sre6e8et2sabtf7rtrc0u812.apps.googleusercontent.com',
  googleClientSecret: 'gcCJByKtspHxUU_xE_LC8c96',
  mongoURI:
    'mongodb://peh2admin:$0qj2WdNzNb40u812@ds025802.mlab.com:25802/emaily-dev',
  randomCookieKey:
    'Apy7tNf7SsWbFK3EUTWLc0hNRmpXV4WTYFnoP2xUPr6UvR6ZzfLGQOa0u812',
    googleRedirectURI: 'http://localhost:5000/auth/google'
};
```

`passport.js`

```
// more code

passport.use(
  new GoogleStrategy(
    {
      clientID: keys.googleClientID,
      clientSecret: keys.googleClientSecret,
      callbackURL: keys.googleRedirectURI
    },
// more code
```

* But the relative path is easier and we'll use that

`passport.js`

```
// more code
passport.use(
  new GoogleStrategy(
    {
      clientID: keys.googleClientID,
      clientSecret: keys.googleClientSecret,
      callbackURL: '/auth/google/callback',
      proxy: true
    },
// more code
```

* We just add `proxy: true` and we are good to go!

## Test it out
* Add and commit and push to heroku
* Visit `https://mysterious-sierra-29112.herokuapp.com/auth/google`
* You should get redirected to permission screen
* If you accept, you will be taking to a broken route page
* But check your production `MongoDB` and you should see the user and the Google profile id inside it

![prod profile id in user](https://i.imgur.com/rLcuVuI.png)

* And if you visit `https://mysterious-sierra-29112.herokuapp.com/api/current_user`
    - It will show you the current user you are logged in as
    - And you can logout with
        + `https://mysterious-sierra-29112.herokuapp.com/api/logout`

## Tip
* Push an empty commit

`$ git commit --allow-empty -m "empty commit"`

* This is if you want to push again but you didn't change anything
    - I might change a password on mLab and I can't push to heroku unless there is a change
    - This is the way around that
