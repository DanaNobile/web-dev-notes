# Broadcasting Events
* To test locally, we'll use separate tabs
* But same would work on Heroku with separate browsers on separate networks
* As long as everyone has same URL in browser they will be connected regardless of which machine they are on
    - We can't test this on localhost
    - But when we deploy to heroku we can
        + With testing on phone
        + And browser running on machine

## Message everybody
* When we emit an event all connected users get that message

### io.emit() vs socket.emit()
* socket.emit() emits an event to a single connection
* io.emit() emits an event to every single connection
* We'll remove our existing emil calls from server.js and index.js

`server.js`

```js
// MORE CODE
app.use(express.static(publicPath));

io.on('connection', socket => {
  console.log('New user connected');

  socket.on('createMessage', message => {
    console.log('createMessage', message);
    io.emit('newMessage', {
      from: message.from,
      text: message.text,
      createdAt: new Date().getTime(),
    });
  });
});
// MORE CODE
```

* We add `createdAt` which will be generated by server to prevent a specific client from "spoofing" when a message was created

`index.js`

```js
const socket = io(); // opens a connection

socket.on('connect', () => {
  console.log('Connected to server');
});

socket.on('disconnect', () => {
  console.log('Disconnected from server');
});

socket.on('newMessage', message => {
  console.log('newMessage', message);
});
```

## Test this
* Open up 2 connection to the server
* Emit some events

`$ nodemon server/server.js`

* Open two chrome browser tabs with console open in both
* Each tab you open you will see a new `New user connected` in terminal

### In console of one browser tab
`> socket.emit('createMessage', { from: 'JohnDoe', text: 'This should work!'});`

* Will send that message and data to every connected tab

## What just happened
1. I admit my event from the browser
2. It goes to the server
3. The server will send the message to every connected user
4. Including the currently connected user who send the message
5. This creates a very basic messaging system

## Git commit and push to heroku (using my aliases from dotfiles)
`$ gs`
`$ gc -am 'Emit newMessage on createMessage`
`$ gpush`
`$ git push`
`$ gph`
`$ heroku open`

* You should see `The Chat App` on your heroku live URL
* Open up Firefox and put browsers side by side (in live heroku URL)
* In FF navicon > Developer > Web Console
* In Chrome console type:

`> socket.emit('createMessage', { from: 'Eckart Tolle', text: 'Now is when?'});`

* After pressing enter you will see this in both Chrome and FF consoles:

`newMessage Object { from: "Eckart Tolle", text: "Now is when?", createdAt: 1514867486603 }

* Everyone in the world can go to this URL and when they do they will see the message in the console
* Close FF

## A different way to emit events
* Some events you want to send to everybody
* The message should go to everyone including the sender so it can show up inside a list of messages
* Other events should only go to other people
    - If user1 emits an event it should go back to user1 but just to user2 and user3
        + Example: when user joins chat room
        + Should get a message: andrew joins other users
            * And andrew should get a message 'Welcome Andrew'
            * This is done via **broadcasting**

### Broadcasting
* Is a term for emitting an event to everybody except one specific user
* With broadcasting we have to specify the individual socket
    - The user we pass here won't get the event, everyone else connected will
    - broadcast is an object that has its own `emit()` function

`server.js`

```js
// MORE CODE
socket.on('createMessage', message => {
  console.log('createMessage', message);
  // io.emit('newMessage', {
  //   from: message.from,
  //   text: message.text,
  //   createdAt: new Date().getTime(),
  // });
  socket.broadcast.emit('newMessage', {
    from: message.from,
    text: message.text,
    createdAt: new Date().getTime(),
  });
});
// MORE CODE
```

## We are testing locally
* `$ node server/server.js`
* Two tabs in Chrome
* Use up arrow to type previous console test:

`> socket.emit('createMessage', { from: 'Eckart Tolle', text: 'Now is when?'});`

* The difference is the message gets sent to all other connected users but not the sender
* This is because this tab broadcast the event which means it only is received by other users connected

## Challenge
* Emit 2 events right when user connects
* first call socket.emit to emit a message to the user that joined
    - The message should come from the admin
    - The text should say welcome to the chat app
* Also call socket.broadcast.emit()
    - Gets sent to everyone but the user that joined
    - from admin and text is New user joined
* At end day when you join a chat room we are greeting and everyone is made aware that you joined
* Both events will be newMessage events
    - from, text and createdAt
* Test in browser (two tabs)
    - First one should see greeting
    - Second one should show alert that a new user joined

## Solution
`server.js`

```js
app.use(express.static(publicPath));

io.on('connection', socket => {
  console.log('New user connected');

  socket.emit('newMessage', {
    from: 'Admin',
    text: 'Welcome to the chat app',
    createdAt: new Date().getTime(),
  });

  socket.broadcast.emit('newMessage', {
    from: 'Admin',
    text: 'New User Joined',
    createdAt: new Date().getTime(),
  });

  socket.on('createMessage', message => {
    console.log('createMessage', message);
    io.emit('newMessage', {
      from: message.from,
      text: message.text,
      createdAt: new Date().getTime(),
    });
  });
});
```

* Close chrome and open one tab at a time
* Make sure when testing that you open chrome tab and dev tools without ever visiting the localhost:3000
* Once dev tools are open then visit localhost:3000
* After visiting you will see Welcome to chat app message (socket.emit is working)
* Open another tab and do same thing and you'll see same message
* Visit previous tab and you'll see "New User Joined" message (broadcast emit is working) 

## Summary
* We have a rudimentary but working messaging system

## Git
`$ gs`
`$ gc -am 'Greet new user and alert others`
